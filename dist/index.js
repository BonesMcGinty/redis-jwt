'use strict';var _stringify=require('babel-runtime/core-js/json/stringify');var _stringify2=_interopRequireDefault(_stringify);var _assign=require('babel-runtime/core-js/object/assign');var _assign2=_interopRequireDefault(_assign);var _typeof2=require('babel-runtime/helpers/typeof');var _typeof3=_interopRequireDefault(_typeof2);var _promise=require('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _regenerator=require('babel-runtime/regenerator');var _regenerator2=_interopRequireDefault(_regenerator);var _asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator');var _asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);var _classCallCheck2=require('babel-runtime/helpers/classCallCheck');var _classCallCheck3=_interopRequireDefault(_classCallCheck2);var _createClass2=require('babel-runtime/helpers/createClass');var _createClass3=_interopRequireDefault(_createClass2);var _redisFastDriver=require('redis-fast-driver');var _redisFastDriver2=_interopRequireDefault(_redisFastDriver);var _jsonwebtoken=require('jsonwebtoken');var _jsonwebtoken2=_interopRequireDefault(_jsonwebtoken);var _shelljs=require('shelljs');var _shelljs2=_interopRequireDefault(_shelljs);var _chalk=require('chalk');var _chalk2=_interopRequireDefault(_chalk);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var Jwt=function(){function Jwt(secret){(0,_classCallCheck3.default)(this,Jwt);this.secret=secret;}(0,_createClass3.default)(Jwt,[{key:'create',value:function(){var _ref=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(_id,_verify){return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return _jsonwebtoken2.default.sign({_id:_id,_verify:_verify},this.secret);case 3:return _context.abrupt('return',_context.sent);case 6:_context.prev=6;_context.t0=_context['catch'](0);return _context.abrupt('return',false);case 9:case'end':return _context.stop();}}},_callee,this,[[0,6]]);}));function create(_x,_x2){return _ref.apply(this,arguments);}return create;}()},{key:'verify',value:function(){var _ref2=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2(token){return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;return _context2.abrupt('return',_jsonwebtoken2.default.verify(token,this.secret));case 4:_context2.prev=4;_context2.t0=_context2['catch'](0);return _context2.abrupt('return',false);case 7:case'end':return _context2.stop();}}},_callee2,this,[[0,4]]);}));function verify(_x3){return _ref2.apply(this,arguments);}return verify;}()}]);return Jwt;}();var Driver=function(){function Driver(config){(0,_classCallCheck3.default)(this,Driver);this.config=config;this.r=new _redisFastDriver2.default(this.config);this.events();}(0,_createClass3.default)(Driver,[{key:'exec',value:function exec(){return this.r;}},{key:'events',value:function events(){var _this=this;var uri=this.config.host+':'+this.config.port+'/'+this.config.db;this.r.on('ready',function(){console.log(_chalk2.default.greenBright('-------\nRedis['+_this.config.name+']-> connected on '+uri+'\n-------'));});this.r.on('connected',function(){});this.r.on('disconnected',function(){console.log(_chalk2.default.redBright('Redis['+_this.config.name+']-> disconnected: '+uri));});this.r.on('error',function(err){console.log(_chalk2.default.redBright('Redis['+_this.config.name+']-> error: '+uri+' - detail: '+err));});setTimeout(function(){_this.ping();},2000);}},{key:'ping',value:function(){var _ref3=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3(){return _regenerator2.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return this.r.rawCall(['ping']);case 2:if(_context3.sent){_context3.next=5;break;}console.log(_chalk2.default.redBright('Redis['+name+']-> Could not establish a connection: '+uri));process.exit(-1);case 5:case'end':return _context3.stop();}}},_callee3,this);}));function ping(){return _ref3.apply(this,arguments);}return ping;}()},{key:'create',value:function(){var _ref4=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee4(key,value,ttl){var id;return _regenerator2.default.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;id=key.split(':')[0];if(this.config.multiple){_context4.next=5;break;}_context4.next=5;return this.destroyMultiple(id);case 5:if(!ttl){_context4.next=10;break;}_context4.next=8;return this.r.rawCall(['SETEX',key,ttl,value]);case 8:_context4.next=12;break;case 10:_context4.next=12;return this.r.rawCall(['SET',key,value]);case 12:_context4.next=17;break;case 14:_context4.prev=14;_context4.t0=_context4['catch'](0);throw'Error 1 Redis '+_context4.t0;case 17:return _context4.abrupt('return',true);case 18:case'end':return _context4.stop();}}},_callee4,this,[[0,14]]);}));function create(_x4,_x5,_x6){return _ref4.apply(this,arguments);}return create;}()},{key:'exists',value:function(){var _ref5=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee5(key){var _this2=this;return _regenerator2.default.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:return _context5.abrupt('return',new _promise2.default(function(resolve,reject){_this2.r.rawCall(['EXISTS',key],function(err,result){if(result)resolve(result);resolve(null);});}));case 1:case'end':return _context5.stop();}}},_callee5,this);}));function exists(_x7){return _ref5.apply(this,arguments);}return exists;}()},{key:'ttl',value:function(){var _ref6=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee6(key){var _this3=this;return _regenerator2.default.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:return _context6.abrupt('return',new _promise2.default(function(resolve,reject){_this3.r.rawCall(['ttl',key],function(err,result){if(result)resolve(result);resolve(null);});}));case 1:case'end':return _context6.stop();}}},_callee6,this);}));function ttl(_x8){return _ref6.apply(this,arguments);}return ttl;}()},{key:'getValuesByPattern',value:function(){var _ref7=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee7(pattern){var _this4=this;return _regenerator2.default.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:return _context7.abrupt('return',new _promise2.default(function(resolve,reject){_this4.r.rawCall(['keys',pattern+':*'],function(err,keys){var query=['MGET'].concat(keys);_this4.r.rawCall(query,function(err,result){if(result)resolve(result);resolve(null);});});}));case 1:case'end':return _context7.stop();}}},_callee7,this);}));function getValuesByPattern(_x9){return _ref7.apply(this,arguments);}return getValuesByPattern;}()},{key:'getCountByPattern',value:function(){var _ref8=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee8(pattern){var _this5=this;return _regenerator2.default.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:return _context8.abrupt('return',new _promise2.default(function(resolve,reject){_this5.r.rawCall(['keys',pattern+':*'],function(err,result){if(result)resolve(result.length);resolve(null);});}));case 1:case'end':return _context8.stop();}}},_callee8,this);}));function getCountByPattern(_x10){return _ref8.apply(this,arguments);}return getCountByPattern;}()},{key:'getInfo',value:function(){var _ref9=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee9(section){var _this6=this;return _regenerator2.default.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:return _context9.abrupt('return',new _promise2.default(function(resolve,reject){var query=section==='DBSIZE'?['DBSIZE']:['INFO',section];_this6.r.rawCall(query,function(err,result){if(result)resolve(result);resolve(null);});}));case 1:case'end':return _context9.stop();}}},_callee9,this);}));function getInfo(_x11){return _ref9.apply(this,arguments);}return getInfo;}()},{key:'destroy',value:function(){var _ref10=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee10(key){var _this7=this;return _regenerator2.default.wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:return _context10.abrupt('return',new _promise2.default(function(resolve,reject){_this7.r.rawCall(['DEL',key],function(err,result){if(result)resolve(result);resolve(null);});}));case 1:case'end':return _context10.stop();}}},_callee10,this);}));function destroy(_x12){return _ref10.apply(this,arguments);}return destroy;}()},{key:'destroyMultiple',value:function(){var _ref11=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee11(key){var _this8=this;return _regenerator2.default.wrap(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:return _context11.abrupt('return',new _promise2.default(function(resolve,reject){_this8.r.rawCall(['KEYS',key+':*'],function(err,keys){keys.join();keys.splice(0,0,"DEL");_this8.r.rawCall(keys,function(err,result){if(result)resolve(result);resolve(null);});});}));case 1:case'end':return _context11.stop();}}},_callee11,this);}));function destroyMultiple(_x13){return _ref11.apply(this,arguments);}return destroyMultiple;}()}]);return Driver;}();var RedisJwt=function(){function RedisJwt(config){(0,_classCallCheck3.default)(this,RedisJwt);if(config.KEA){if(_shelljs2.default.exec('redis-cli config set notify-keyspace-events KEA').code!==0){_shelljs2.default.echo('Error: notify-keyspace-events KEA failed');_shelljs2.default.exit(1);}}this.config={};this.config.name='redis-jwt';this.config.host=config.host||'127.0.0.1';this.config.port=config.port||6379;this.config.db=config.db||0;this.config.maxretries=config.maxretries||10;this.config.auth=config.auth||false;this.config.secret=config.secret||'secret';this.config.multiple=!config.multiple?false:true;this.r=new Driver(this.config);this.j=new Jwt(this.config.secret);}(0,_createClass3.default)(RedisJwt,[{key:'create',value:function(){var _ref12=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee12(_req,_id,_param1,_param2){var _ttl,_extra,session,token,key,data;return _regenerator2.default.wrap(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:_context12.prev=0;_ttl=null;_extra={};if(!((typeof _param1==='undefined'?'undefined':(0,_typeof3.default)(_param1))!=='object'&&!_param2)){_context12.next=7;break;}_ttl=_param1;_context12.next=13;break;case 7:if(!((typeof _param1==='undefined'?'undefined':(0,_typeof3.default)(_param1))==='object')){_context12.next=12;break;}_extra=_param1;_ttl=_param2||null;_context12.next=13;break;case 12:throw'redis-jwt-> Error: create(req, key, object, ttl)';case 13:session={_verify:this.makeid(11),_agent:_req.headers['user-agent'],_ip:_req.headers['x-forwarded-for']||_req.connection.remoteAddress};(0,_assign2.default)(session,_extra);_context12.next=17;return this.j.create(_id,session._verify);case 17:token=_context12.sent;key=_id+':'+session._verify;data=(0,_stringify2.default)(session);_context12.next=22;return this.r.create(key,data,_ttl);case 22:return _context12.abrupt('return',token);case 25:_context12.prev=25;_context12.t0=_context12['catch'](0);throw _chalk2.default.redBright(_context12.t0);case 28:case'end':return _context12.stop();}}},_callee12,this,[[0,25]]);}));function create(_x14,_x15,_x16,_x17){return _ref12.apply(this,arguments);}return create;}()},{key:'verify',value:function(){var _ref13=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function _callee13(token){var decode,_key,_ttl;return _regenerator2.default.wrap(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:_context13.prev=0;_context13.next=3;return this.j.verify(token);case 3:decode=_context13.sent;if(decode){_context13.next=6;break;}return _context13.abrupt('return',false);case 6:_key=decode._id+':'+decode._verify;_context13.next=9;return this.r.exists(_key);case 9:if(_context13.sent){_context13.next=11;break;}return _context13.abrupt('return',false);case 11:_context13.next=13;return this.r.ttl(_key);case 13:_ttl=_context13.sent;(0,_assign2.default)(decode,{_key:_key,_ttl:_ttl});return _context13.abrupt('return',{rjwt:decode});case 18:_context13.prev=18;_context13.t0=_context13['catch'](0);throw _chalk2.default.redBright(_context13.t0);case 21:case'end':return _context13.stop();}}},_callee13,this,[[0,18]]);}));function verify(_x18){return _ref13.apply(this,arguments);}return verify;}()},{key:'call',value:function call(){return this.r;}},{key:'exec',value:function exec(){return this.r.exec();}},{key:'makeid',value:function makeid(length){var text="";var possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<length;i++){text+=possible.charAt(Math.floor(Math.random()*possible.length));}return text;}}]);return RedisJwt;}();module.exports=RedisJwt;